<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="com.baobab.m.dao.GetOurCPMapper">
		<!-- 인기순 -->
		<select id="getOursPopularity" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_name like #{searchWord} or CP_kind like #{searchWord} or CP_address like #{searchWord} or CP_addr_details like #{searchWord} or CP_Theme1 like #{searchWord} or CP_Theme2 like #{searchWord} or CP_type like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc limit 20 offset #{listCount}]]> 
		</select>
		<select id="getOursPopLocation" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_address like #{searchWord} or CP_addr_details like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc  limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursPopCpName" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_name like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc  limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursPopMenu" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and CP_name in(select CP_name from menu where menu_name like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc  limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursPopKind" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (CP_name like #{searchWord} or CP_address like #{searchWord} or CP_addr_details like #{searchWord}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc  limit 20 offset #{listCount}]]>
		</select>
		<select id="getOurCouponPopularity" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select ci.*,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci join coupon_cp as cc on ci.seq_num = cc.cp_seq where cc.status = 'on' and (ci.CP_theme1 regexp #{theme1_1} or ci.CP_theme2 regexp #{theme1_1}) and (ci.CP_name like #{searchWord} or ci.CP_address like #{searchWord} or ci.CP_addr_details like #{searchWord}) and (ci.Business_start <= DATE_FORMAT(now(), '%H:%i') and ci.Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(ci.close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(ci.close_day, '~', 1) not like #{day}) and ci.cp_div = '음식점' group by ci.seq_num order by ((select count(*) from payment where cp_seq = ci.seq_num) + (select count(*) from review where cp_seq = ci.seq_num) + (select sum(use_ea) from coupon_cp where cp_seq = ci.seq_num)) desc limit 20 offset #{listCount}]]>
		</select>
		
		<!-- 거리순 -->
		<select id="getOursDistance" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_name like #{searchWord} or CP_kind like #{searchWord} or CP_address like #{searchWord} or CP_addr_details like #{searchWord} or CP_Theme1 like #{searchWord} or CP_Theme2 like #{searchWord} or CP_type like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursDisLocation" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_address like #{searchWord} or CP_addr_details like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursDisCpName" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_name like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursDisMenu" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and CP_name in(select CP_name from menu where menu_name like #{searchWord}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		<select id="getOursDisKind" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info where (CP_address like #{location} or CP_addr_details like #{location}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (CP_name like #{searchWord} or CP_address like #{searchWord} or CP_addr_details like #{searchWord}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		<select id="getOurCouponDistance" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select ci.*,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info as ci join coupon_cp as cc on ci.seq_num = cc.cp_seq where cc.status = 'on' and (ci.CP_theme1 regexp #{theme1_1} or ci.CP_theme2 regexp #{theme1_1}) and (ci.CP_name like #{searchWord} or ci.CP_address like #{searchWord} or ci.CP_addr_details like #{searchWord}) and (ci.Business_start <= DATE_FORMAT(now(), '%H:%i') and ci.Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(ci.close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(ci.close_day, '~', 1) not like #{day}) and ci.cp_div = '음식점' group by ci.seq_num order by distance limit 20 offset #{listCount}]]>
		</select>
		
		<!-- 주변검색 -->
		<select id="getSurroundingsOur" parameterType="com.baobab.m.vo.PageSearchVO" resultType="com.baobab.m.vo.CPInfoVO">
			<![CDATA[select *,(6371*acos(cos(radians(#{latitude}))*cos(radians(latitude))*cos(radians(longitude)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(latitude)))) as distance from cp_info having distance <= 20 and (CP_theme1 regexp #{theme1_1} or CP_theme2 regexp #{theme1_1}) and (CP_kind regexp #{kind} or CP_type regexp #{kind}) and (Business_start <= DATE_FORMAT(now(), '%H:%i') and Business_end > DATE_FORMAT(now(), '%H:%i')) and (substring_index(substring_index(close_day, '~', #{weeks}), '~', -1) not like #{day} and substring_index(close_day, '~', 1) not like #{day}) and cp_div = '음식점' order by distance limit 20 offset #{listCount}]]>
		</select>
		
	</mapper>